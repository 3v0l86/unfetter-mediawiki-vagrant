# RESTBase config
templates:

  wmf-content-1.0.0: &wp/content/1.0.0
    swagger: '2.0'
    # swagger options, overriding the shared ones from the merged specs (?)
    info: &wp/content-info/1.0.0
      version: 1.0.0-beta
      title: Wikimedia REST API
      description: >
          This API aims to provide straightforward and low-latency access to
          Wikimedia content and services. It is currently in beta testing, so
          things aren't completely locked down yet. Each entry point has
          explicit stability markers to inform you about development status
          and change policy, according to [our API version
          policy](https://www.mediawiki.org/wiki/API_versioning).

          ### High-volume access
            - As a general rule, don't perform more than 200 requests/s to
              this API.
            - Set a unique `User-Agent` header that allows us to contact you
              quickly. Email addresses or URLs of contact pages work well.
            - Consider using our [HTML
              dumps](https://phabricator.wikimedia.org/T17017) once they
              become available.

      termsOfService: https://wikimediafoundation.org/wiki/Terms_of_Use
      contact:
        name: the Wikimedia Services team
        url: http://mediawiki.org/wiki/RESTBase
      license:
        name: Apache2
        url: http://www.apache.org/licenses/LICENSE-2.0

    securityDefinitions: &wp/content-security/1.0.0
      mediawiki_auth:
        description: Checks permissions using MW api
        type: apiKey
        in: header
        name: cookie
        x-internal-request-whitelist:
          # allow everything, as it is not possible to list
          # statically all of the domains that could be used
          # for this in MediaWiki-Vagrant
          - /.+/
      header_match:
        description: Checks client ip against one of the predefined whitelists
        x-error-message: This client is not allowed to use the endpoint
        x-whitelists:
          internal:
            - /^(?:::ffff:)?(?:10|127)\./

    x-modules:
      - name: mobileapps-public
        path: specs/mediawiki/v1/mobileapps
        type: spec
        options:
          host: http://appservice.wmflabs.org

      - path: wikimedia/v1/graphoid_v1.yaml
        options:
          host: http://localhost:<%= @graphoid_port %>

      - path: wikimedia/v1/summary_v1.js
        options:
          # One hour, for now.
          response_cache-control: 'max-age: 3600, s-maxage: 3600'

      - name: mathoid
        path: specs/media/v1/mathoid
        type: spec
        options:
          host: http://localhost:<%= @mathoid_port %>

    x-subspecs:
      - mediawiki/v1/content

  wmf-sys-1.0.0: &wp/sys/1.0.0
    info:
      title: Default MediaWiki sys API module
      version: 1.0.0
    paths:
      /{module:table}: &wp/sys/table
        x-modules:
          # There can be multiple modules too per stanza, as long as the
          # exported symbols don't conflict. The operationIds from the spec
          # will be resolved against all of the modules.
          - name: restbase-mod-table-sqlite
            version: 1.0.0
            type: npm
            options: # Passed to the module constructor
              conf:
                dbname: <%= @dbdir %>/mw-vagrant.sqlite3

      /{module:page_revisions}: &wp/sys/page_revisions
        x-modules:
          - name: page_revisions
            version: 1.0.0
            type: file

      /{module:key_value}: &wp/sys/key_value
        x-modules:
          - name: key_value
            version: 1.0.0
            type: file

      /{module:key_rev_value}: &wp/sys/key_rev_value
        x-modules:
          - name: key_rev_value
            version: 1.0.0
            type: file

      /{module:post_data}: &wp/sys/post_data
        x-modules:
          - name: post_data
            version: 1.0.0
            type: file

      /{module:action}: &wp/sys/action
        x-modules:
          - name: action
            type: file
            templates:
              apiRequest:
                method: post
                uri: 'http://localhost<%= scope['::port_fragment'] %>/w/api.php'
                headers:
                  host: '{$.request.params.domain}'
                body: '{$.request.body}'

      /{module:page_save}: &wp/sys/page_save
        x-modules:
          - name: page_save
            type: file

      /{module:parsoid}: &wp/sys/parsoid
        x-modules:
          - name: parsoid
            version: 1.0.0
            type: file
            options:
              parsoidHost: http://localhost:<%= scope['::mediawiki::parsoid::port'] %>

      /{module:mobileapps}:
        x-subspec:
          paths:
            /v1:
              x-modules:
                - name: mobileapps-sys
                  path: mods/wikimedia/v1/mobileapps
                  type: spec
                  options:
                    host: http://appservice.wmflabs.org

  global-content: &gb/content/1.0.0
    swagger: '2.0'
    info: *wp/content-info/1.0.0
    securityDefinitions: *wp/content-security/1.0.0
    x-modules:
      - name: mathoid
        path: specs/media/v1/mathoid
        type: spec
        options:
          host: http://localhost:<%= @mathoid_port %>/complete


  global-sys: &gb/sys/1.0.0
    info:
      title: global domain sys API module
      version: 1.0.0
    paths:
      /{module:table}: *wp/sys/table
      /{module:key_value}: *wp/sys/key_value
      /{module:post_data}: *wp/sys/post_data


  wp-default-1.0.0: &wp/default/1.0.0
    x-subspecs:
      - paths:
          /{api:v1}:
            x-subspec: *wp/content/1.0.0
      - paths:
          /{api:sys}:
            x-subspec: *wp/sys/1.0.0


  global-default-1.0.0: &gb/default/1.0.0
    x-subspecs:
      - paths:
          /{api:v1}:
            x-subspec: *gb/content/1.0.0
      - paths:
          /{api:sys}:
            x-subspec: *gb/sys/1.0.0


# Swagger spec root.
spec: &spec
  title: "The RESTBase root"
  # Some more general RESTBase info
  paths:
    # locally-exposed domain
    /{domain:<%= @domain %>}: *wp/default/1.0.0
    # global domain
    /{domain:wikimedia.org}: *gb/default/1.0.0

salt: secret
default_page_size: 100
user_agent: RESTBase/MW-Vagrant
