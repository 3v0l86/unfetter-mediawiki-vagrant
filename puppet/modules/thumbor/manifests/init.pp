# == Class: Thumbor
#
# This Puppet class installs and configures a Thumbor instance
#
# Thumbor is installed as a Python package, and as part of that,
# pip compiles lxml. This is memory-intensive; you might have to
# increase the memory available to the VM with something like
# 'vagrant config vagrant_ram 2048; vagrant reload'.
#
# === Parameters
#
# [*deploy_dir*]
#   Path where Thumbor should be installed (example: '/var/thumbor').
#
# [*cfg_file*]
#   Thumbor configuration file. The file will be generated by Puppet.
#
class thumbor (
    $deploy_dir,
    $cfg_file,
) {
    require ::virtualenv

    # jpegtran
    require_package('libjpeg-progs')

    $thumbor_cli = "${deploy_dir}/bin/thumbor -c '${cfg_file}'"

    virtualenv::environment { $deploy_dir:
        ensure   => present,
        packages => [
            'thumbor',
        ],
    }

    file { $cfg_file:
        ensure  => present,
        group   => 'www-data',
        content => template('thumbor/thumbor.conf.erb'),
        mode    => '0640',
    }

    file { '/etc/init/thumbor.conf':
        ensure  => present,
        content => template('thumbor/upstart.erb'),
        mode    => '0444',
    }

    service { 'thumbor':
        ensure    => running,
        enable    => true,
        provider  => 'upstart',
        require   => Virtualenv::Environment[$deploy_dir],
        subscribe => File[$cfg_file, '/etc/init/thumbor.conf'],
    }
}
